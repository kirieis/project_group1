<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>H·ªì s∆° ng∆∞·ªùi d√πng - Github Pharmacy</title>
    <link rel="stylesheet" href="home.css" />
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header__inner container">
            <div class="brand">
                <a href="home.html" style="text-decoration: none; display: flex; align-items: center; gap: 14px;">
                    <div class="brand__logo" aria-label="Github logo">
                        <span class="logo-dot"></span>
                        <span class="logo-dot"></span>
                        <span class="logo-dot"></span>
                    </div>
                    <div class="brand__text">
                        <div class="brand__name">Github Pharmacy</div>
                    </div>
                </a>
            </div>

            <div class="search">
                <input id="globalSearch" type="search" placeholder="T√¨m t√™n thu·ªëc, m√£ thu·ªëc..." />
                <button id="btnSearch" class="btn btn--icon" title="T√¨m ki·∫øm" aria-label="T√¨m ki·∫øm">
                    üîç
                </button>
            </div>

            <div class="header__actions">
                <a href="profile.html" id="btnLogout" class="btn btn--ghost" style="text-decoration: none;">
                    üë§ <span id="headerUsername">T√†i kho·∫£n</span>
                </a>
                <button id="btnCart" class="btn btn--primary" onclick="window.location.href='cart.html'">
                    üõí Gi·ªè h√†ng <span id="cartBadge" class="badge">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN PROFILE LAYOUT -->
    <main class="container main">
        <div class="profile-layout">

            <!-- SIDEBAR -->
            <aside class="profile-sidebar">
                <div class="profile-user">
                    <div class="profile-user__avatar">üë§</div>
                    <div class="profile-user__info">
                        <div id="sbName" class="profile-user__name">User Name</div>
                        <div id="sbRole" class="profile-user__role">Member</div>
                    </div>
                </div>

                <nav class="profile-nav">
                    <button class="profile-nav__item active" onclick="showTab('overview')">
                        üîπ T·ªïng quan
                    </button>
                    <button class="profile-nav__item" onclick="showTab('history')">
                        üìã L·ªãch s·ª≠ mua h√†ng
                    </button>
                    <button class="profile-nav__item" onclick="showTab('info')">
                        üë§ Th√¥ng tin c√° nh√¢n
                    </button>
                    <div id="adminLinkContainer"></div>
                </nav>

                <button class="profile-logout" onclick="window.location.href='logout'">
                    üö™ ƒêƒÉng xu·∫•t
                </button>
            </aside>

            <!-- CONTENT AREA -->
            <div class="profile-content">

                <!-- Tab: Overview -->
                <div id="tab-overview" class="profile-tab active">
                    <h2 class="profile-heading">T·ªïng quan</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__icon">üõí</div>
                            <div class="stat-card__info">
                                <div id="summaryCount" class="stat-card__value">0</div>
                                <div class="stat-card__label">ƒê∆°n h√†ng ƒë√£ mua</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon">üí∞</div>
                            <div class="stat-card__info">
                                <div id="summaryTotal" class="stat-card__value">0ƒë</div>
                                <div class="stat-card__label">T·ªïng ti·ªÅn t√≠ch l≈©y</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 32px;">
                        <h3 style="margin-bottom: 16px;">ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>
                        <div class="empty-state">
                            Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o g·∫ßn ƒë√¢y. <a href="home.html">Mua s·∫Øm ngay</a>
                        </div>
                    </div>
                </div>

                <!-- Tab: Purchase History -->
                <div id="tab-history" class="profile-tab">
                    <h2 class="profile-heading">L·ªãch s·ª≠ mua h√†ng</h2>
                    <div class="empty-state">
                        B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.
                    </div>
                </div>

                <!-- Tab: Personal Info -->
                <div id="tab-info" class="profile-tab">
                    <h2 class="profile-heading">Th√¥ng tin c√° nh√¢n</h2>
                    <div class="info-card">
                        <div class="field">
                            <span>H·ªç v√† t√™n</span>
                            <input type="text" id="infoName" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>S·ªë ƒëi·ªán tho·∫°i</span>
                            <input type="text" id="infoPhone" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>ƒê·ªãa ch·ªâ</span>
                            <input type="text" id="infoAddress" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>T√™n ƒëƒÉng nh·∫≠p</span>
                            <input type="text" id="infoUsername" class="info-input" readonly>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer__inner">
            Connect with us : 03xxxxxxx
        </div>
    </footer>

    <script>
        // 1. Fetch real auth state from server
        async function loadProfile() {
            try {
                const res = await fetch('api/auth-status');
                const data = await res.json();

                if (!data.isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                const currentUser = data;

                // 2. Bind Header
                document.getElementById('headerUsername').textContent = currentUser.fullName;
                document.getElementById('cartBadge').textContent = JSON.parse(localStorage.getItem("cart") || "[]").length;

                // 3. Bind Sidebar
                document.getElementById('sbName').textContent = currentUser.fullName;
                document.getElementById('sbRole').textContent = currentUser.role === 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Th√†nh vi√™n';

                // Admin Link
                if (currentUser.role === 'ADMIN') {
                    document.getElementById('adminLinkContainer').innerHTML = `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <a href="/admin/users" class="profile-nav__item" style="text-decoration:none;">
                            ‚öôÔ∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                        </a>
                        <a href="/admin/sales" class="profile-nav__item" style="text-decoration:none;">
                            üí∞ Doanh thu & Ti·ªÅn l·ªùi
                        </a>
                    </div>
                `;
                }

                // 4. Bind Info Tab
                document.getElementById('infoName').value = currentUser.fullName || '';
                document.getElementById('infoPhone').value = currentUser.phone || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('infoAddress').value = currentUser.address || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('infoUsername').value = currentUser.username || 'user';

                // 5. Fetch Orders
                fetchOrders();
            } catch (e) {
                console.error("Failed to load profile", e);
            }
        }

        async function fetchOrders() {
            try {
                console.log("Fetching orders...");
                const res = await fetch('api/orders');
                const orders = await res.json();
                console.log("Orders received:", orders);

                const historyTab = document.getElementById('tab-history');
                const overviewList = document.querySelector('#tab-overview .empty-state');
                const summaryTotal = document.getElementById('summaryTotal');
                const summaryCount = document.getElementById('summaryCount');

                if (!orders || orders.length === 0) {
                    console.log("No orders found for this user.");
                    return;
                }

                const paidOrders = orders.filter(o => o.status === 'PAID');
                summaryCount.textContent = paidOrders.length;
                let totalSpent = paidOrders.reduce((sum, o) => sum + o.total, 0);

                const renderOrder = (o) => {
                    const dateStr = `${o.day}/${o.month}/${o.year}`;

                    // Logic m√†u s·∫Øc tr·∫°ng th√°i
                    let statusLabel = '‚è≥ Ch·ªù x√°c nh·∫≠n';
                    let statusColor = '#f59e0b';
                    let statusBg = '#fffbeb';

                    if (o.status === 'PAID') {
                        statusLabel = '‚úÖ ƒê√£ ho√†n t·∫•t';
                        statusColor = '#10b981';
                        statusBg = '#f0fdf4';
                    } else if (o.status === 'CANCELLED') {
                        statusLabel = '‚ùå ƒê√£ b·ªã h·ªßy';
                        statusColor = '#ef4444';
                        statusBg = '#fef2f2';
                    }

                    return `
                        <div class="order-card" style="border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; background: #fff; box-shadow: var(--shadow-sm); transition: transform 0.2s;">
                            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                <div>
                                    <span style="font-weight:700; color: var(--primary); display:block;">ƒê∆°n #INV-${o.id}</span>
                                    <span style="font-size: 11px; color: var(--text-muted);">${dateStr}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: block; font-weight:800; color: var(--gold); font-size: 16px;">${o.total.toLocaleString('vi-VN')}ƒë</span>
                                    <span style="display: inline-block; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; color: ${statusColor}; background: ${statusBg}; border: 1px solid ${statusColor}33; margin-top: 4px;">
                                        ${statusLabel}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 13px; margin-bottom: 8px;">
                                ${o.items.map(item => `
                                    <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                                        <span style="color: #475569;">${item.name} <span style="color: #94a3b8;">x${item.qty}</span></span>
                                        <span style="font-weight: 600;">${(item.price * item.qty).toLocaleString('vi-VN')}ƒë</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${o.status === 'PENDING' ? `
                                <div style="margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 8px; font-size: 11px; color: #64748b; font-style: italic;">
                                    üí° H·ªá th·ªëng ƒëang ch·ªù Admin x√°c nh·∫≠n giao d·ªãch c·ªßa b·∫°n.
                                </div>
                            ` : ''}
                        </div>
                    `;
                };

                historyTab.innerHTML = `<h2 class="profile-heading">L·ªãch s·ª≠ mua h√†ng</h2>` + orders.map(renderOrder).join('');
                if (overviewList) {
                    overviewList.parentElement.innerHTML = `<h3 style="margin-bottom: 16px;">ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>` + orders.slice(0, 2).map(renderOrder).join('');
                }
                summaryTotal.textContent = totalSpent.toLocaleString('vi-VN') + "ƒë";
            } catch (e) {
                console.error("Order fetch error", e);
            }
        }

        loadProfile();

        // Tab Switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.profile-tab').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById('tab-' + tabName).classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.profile-nav__item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>

</html>